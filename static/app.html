
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>OpenGlass: Glassware Debug</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      
      }
      .container {
        margin-right: auto;
        margin-left: auto;
        max-width: 680px;
      }
    </style>
<style>

path.link {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}

circle {
  fill: #ccc;
  stroke: #fff;
  stroke-width: 1.5px;
}


text {
  font: 10px sans-serif;
  pointer-events: none;
}

text.shadow {
  stroke: #fff;
  stroke-width: 3px;
  stroke-opacity: .8;
}

img.thumb {
  height: 150px;
  width: 150px;
}
</style>
<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <link href="static/bootstrap-switch.css" rel="stylesheet">
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.10/backbone-min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.0/mustache.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="static/bootstrap-switch.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
  </head>
  <body>
    <script type="text/javascript">
      function setFlags(flags, success) {
          $.ajax({url: 'flags', type: 'POST', data: JSON.stringify(flags), success: success});
      }
      function getFlags(success) {
          $.ajax({url: 'flags', type: 'GET', success: success});
      }
      function unsetFlags(flags, success) {
          $.ajax({url: 'flags', type: 'DELETE', data: JSON.stringify(flags), success: success});
      }

      function createKey(type, success, error) {
          var xhr = $.ajax({url: 'user/key/' + type, type: 'POST', success: success});
          if (!_.isUndefined(error)) {
              xhr.error(error);
          }
      }

      function connectWebsocket() {
          var ws = new WebSocket("ws://api3.picar.us:16001/borg/web");
          ws.onopen = function () {
              _.each(_.range(0, 12), function (x) {
                  $('#sensors').append($('<div>').attr('id', 'sensor_' + x));
              });
          }
          ws.onclose = function () {

          }
          ws.onmessage = function (event) {
              response = JSON.parse(event.data);
              if (response.action == "image") {
                  latestImage = response.imageb64;
                  $('#latest-image').attr('src', 'data:image/jpeg;base64,' + latestImage);
              } else if (response.action == "sensors") {
                  response_sensor = response;
                  _.each(response.sensors, function (x) {
                      $('#sensor_' + x.type).html(_.escape(JSON.stringify(x)));
                  })
              }
          }
          ws.onclose = function (event) {
              //alert("Websocket closed");
          }
          return ws;
      }

      ws = connectWebsocket();
      function initCanvas() {
          var $canvas = $('#canvas')[0];

          var context = $canvas.getContext('2d');
          context.fillStyle   = '#FF00FF'; // set canvas background color
          context.fillRect  (0,   0, 640, 360);  // now fill the canvas

          tool = {};
          function ev_canvas (ev) {
              if (ev.layerX || ev.layerX == 0) { // Firefox
                  ev._x = ev.layerX;
                  ev._y = ev.layerY;
              } else if (ev.offsetX || ev.offsetX == 0) { // Opera
                  ev._x = ev.offsetX;
                  ev._y = ev.offsetY;
              }
              var evtype = ev.type;
              if (evtype.slice(0, 5) == "touch" && event.touches.length == 1) {
                  console.log('Touch')
                  ev._x = ev.touches[0].pageX;
                  ev._y = ev.touches[0].pageY;
              }
              console.log(ev._x + " " + ev._y)
              //console.log(ev.pageX + " " + ev.pageY)

              var func = tool[evtype];
              if (func) {
                  func(ev);
              }
          }

          $canvas.addEventListener('mousedown', ev_canvas, false);
          $canvas.addEventListener('mousemove', ev_canvas, false);
          $canvas.addEventListener('mouseup', ev_canvas, false);
          $canvas.addEventListener('touchmove', ev_canvas, false);
          $canvas.addEventListener('touchstart', ev_canvas, false);
          $canvas.addEventListener('touchend', ev_canvas, false);
          tool.drawing = false;
          tool.mousemove = function (ev) {
              console.log('Mouse move')
              if (this.drawing) {
                  context.lineTo(ev._x, ev._y);
                  context.stroke();
              }
          };
          tool.mousedown = function (ev) {
              console.log('Mouse down')
              context.beginPath();
              context.moveTo(ev._x, ev._y);
              this.drawing = true;
          };
          tool.mouseup = function (ev) {
              console.log('Mouse up')
              if (this.drawing) {
                  tool.mousemove(ev);
                  this.drawing = false;
                  var datauri = $('#canvas')[0].toDataURL();//"image/jpeg", .2
                  $('#canvasMirror').attr('src', datauri);
                  ws.send(JSON.stringify({action: 'setOverlay', imageb64: datauri.split(',')[1]}));
              }
          };

          tool.touchmove = function (ev) {
              console.log('Touch move')
              if (this.drawing) {
                  context.lineTo(ev.pageX, ev.pageY);
                  context.stroke();
              }
          };
          tool.touchstart = function (ev) {
              console.log('Touch start');
              context.beginPath();
              context.moveTo(ev.pageX, ev.pageY);
              this.drawing = true;
          };
          tool.touchend = function (ev) {
              console.log('Touch end')
              if (this.drawing) {
                  tool.touchmove(ev);
                  this.drawing = false;
                  var datauri = $('#canvas')[0].toDataURL();//"image/jpeg", .2
                  $('#canvasMirror').attr('src', datauri);
                  ws.send(JSON.stringify({action: 'setOverlay', overlayb64: datauri.split(',')[1]}));
              }
          };

      }


      function main () {
          $('#buttonAuth').click(function () {
              window.location.replace('auth');
          });
          $('#buttonSignout').click(function () {
              $.post('signout', {success: function () {location.reload()}}).error(function () {alert("Could not signout")});
          });

          $('#buttonSetup').click(function () {
              $.post('setup').error(function () {alert("Could not setup")});
          });

          $('#buttonRaven').click(function () {
              createKey("raven", function (x) {$('#secret-raven').html(_.escape(x))}, function () {alert("Could not get raven")})
          });
          $('#matchImage').click(function () {
              ws.send(JSON.stringify({action: 'setMatchImage', imageb64: latestImage}));
          });

          $('.flag-check').change(function () {
              var $this = $(this);
              if (this.checked) {
                  setFlags([$this.attr('name')]);
              } else {
                  unsetFlags([$this.attr('name')]);
              }
          });
          getFlags(function (x) {
              _.each(JSON.parse(x), function (y) {
                  $('.flag-check[name=' + y + ']').prop('checked', true);
              });
          });
          initCanvas();
          //$('#files').change(_.partial(handleFileSelect, sendImage));
      }
      $(main);
    </script>
    <div class="container">
        <div class="row">
      <input class="flag-check" name="location" type="checkbox" />
      <input class="flag-check" name="match_memento" type="checkbox" />
      <input class="flag-check" name="raven" type="checkbox" />
      <input class="flag-check" name="crowdqa" type="checkbox" />
      <input class="flag-check" name="match_annotated" type="checkbox" />
      <input class="flag-check" name="match_memento_glog" type="checkbox" />
      <input class="flag-check" name="borg_local_image" type="checkbox" />
      <input class="flag-check" name="borg_local_sensors" type="checkbox" />
      <input class="flag-check" name="borg_server_image" type="checkbox" />
      <input class="flag-check" name="borg_server_sensors" type="checkbox" />
      <input class="flag-check" name="borg_web_image" type="checkbox" />
      <input class="flag-check" name="borg_web_sensors" type="checkbox" />
      <input class="flag-check" name="warp" type="checkbox" />
      <input class="flag-check" name="predict" type="checkbox" />
      <input class="flag-check" name="location_flickr" type="checkbox" />
      <input class="flag-check" name="location_streetview" type="checkbox" />
      </div>
        <div class="row">
          <div class="span7">
            <button id="buttonAuth" class="btn btn-large btn-block btn-primary" type="button">Authenticate</button>
            <button id="buttonSignout" class="btn btn-large btn-block" type="button">Sign Out</button>
            <button id="buttonSetup" class="btn btn-large btn-block btn-primary" type="button">Setup</button>
            <button id="buttonRaven" class="btn btn-large btn-block btn-primary" type="button">Raven</button>
          </div>
        </div>
        <div class="row">
          <span id="secret-raven"></span>
        </div>
        <div class="row">
          <img id="latest-image" \>
          <button id="matchImage" class="btn btn-large btn-block btn-primary" type="button">Match Image</button>
        </div>
        <div class="row">
          <canvas id="canvas" width="640" height="360">
        </div>
        <div class="row">
          <img id="canvasMirror" width="640" height="360" \>
        </div>
        <div class="row">
          <div id="sensors" \>
        </div>

        <div class="row">
          <h1>Simulate</h1>
          <select>
            <option value="openglass">OpenGlass</option>
            <option value="memento">Memento</option>
          </select>
          <input type="text" name="fname">
          <div class="span6 well"><input type="file" id="files" /></div>
          <input type="submit" value="Submit" id="simulate-submit">
        </div>

    </div> <!-- /container -->
  </body>
</html>
