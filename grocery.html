
<html style="width:100%; height:100%; overflow:hidden">
<head>
<script src="//cdnjs.cloudflare.com/ajax/libs/zepto/1.0/zepto.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
<script src="glassgap.js"></script>
</head>
<body style="width:100%; height:100%; overflow:hidden; margin:0">
<canvas id="canvas" width="427" height="240" style="display:block">
</canvas>
<script>
function deg2rad(deg) {
    return deg * (Math.PI/180)
}

function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    // From: http://stackoverflow.com/questions/27928/how-do-i-calculate-distance-between-two-latitude-longitude-points
    var R = 6371; // Radius of the earth in km
    var dLat = deg2rad(lat2-lat1);
    var dLon = deg2rad(lon2-lon1); 
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    var d = R * c; // Distance in km
    return d;
}

function isIndoors(data) {
    // Basic indoor/outdoor using light sensor: During daylight hours if the value is low then assume we are indoors
    if (data.type != 5)  // If not light sensor then quit
        return;
    var minSamples = 2;
    var thresh = 200;
    var indoors = (new Date()).getHours() > 8 && (new Date()).getHours() < 19 && data.values[0] < thresh;
    // Smooth out the signal with a saturating counter
    if (!_.has(window, 'indoorCount'))
        indoorCount = 0;
    indoorCount += indoors * 2 - 1;
    if (indoorCount >= minSamples) {
        indoorCount = minSamples
        GG.log("Indoors");
        return true;
    }
    if (-indoorCount >= minSamples)
        indoorCount = -minSamples;
    return false;
}

function nearGrocery(data) {
    if (!_.has(window, 'grocery'))
        grocery = false;
    if (data.type != -1)  // If not GPS then quit
        return grocery;
    // If you're near a specific whole foods
    d = getDistanceFromLatLonInKm(data.values[0], data.values[1], 38.90969, -77.033134);
    GG.log(d);
    grocery = d < .1;
    if (grocery)
        GG.log("Near grocery");
    return grocery;
}

function sendList() {
    GG.serverTimeline(JSON.stringify({"html": "<article style='left: 0px; visibility: visible;'><section><ul class='text-x-small'><li>Gingerbread</li><li>Chocolate Chip Cookies</li><li>Tiramisu</li><li>Donuts</li><li>Sugar Plum Gummies</li></ul></section><footer><p>Grocery list</p></footer></article>",
        "notification": {
            "level": "DEFAULT"
        }
    }));
}

function cb(data) {
    if (nearGrocery(data) && isIndoors(data)) {
        GG.say('Sending grocery list');
        sendList();
        _.each([-1, 5], function (x) {GG.sensorOff(x)});
    }
}

function server() {
    _.each([-1, 5], function (x) {GG.sensorOn(x)});
    GG.sensorCallback("cb");
}
$(function () {
    GG.serverConnect('PUT_SERVER_HERE', 'server');
});
</script>
</body>
</html>
